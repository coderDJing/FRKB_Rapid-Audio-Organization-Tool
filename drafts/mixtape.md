# Mixtape 时间线重构说明（草案）

更新时间：2026-02-10

## 目标与范围
1. 自动混音仅固定两轨道，不支持多轨并行。
2. 按曲目顺序交替放置：上/下/上/下，首尾相接。
3. 时间线宽度缩到原来的 1/10，放大只影响宽度，轨道高度固定。
4. 波形统一使用真实波形（raw waveform），不使用摘要波形。
5. 进入自动混音窗口时，重新分析 BPM（高精度），仅本窗口生效，不写回库。
6. 节拍对齐功能移除（不做对齐，只画网格线）。

## 布局规则
1. 曲目按列表顺序排布，累计时间线 startX。
2. 轨道交替分配：index 为偶数放上轨，奇数放下轨。
3. 轨道高度固定，不随缩放变化。
4. 轨道间距固定：LANE_GAP = 8。
5. 轨道上方内边距：LANE_PADDING_TOP = 12。

## 缩放与尺寸
1. 时间线宽度缩放系数：MIXTAPE_WIDTH_SCALE = 0.1。
2. 缩放范围：0.1 ~ 2。
3. 缩放步进：ZOOM_STEP = 0.2；渲染量化 RENDER_ZOOM_STEP = 0.2（包含 0.2 档位）。
4. 轨道高度固定：resolveLaneHeightForZoom 固定为 288px（36 * 8）。
5. 放大只影响宽度，轨道高度不随缩放变化。

## 波形策略
1. RAW_WAVEFORM_MIN_ZOOM = 0.1（全档位真实波形）。
2. MIXTAPE_SUMMARY_ZOOM = 0（摘要波形关闭）。
3. 波形按 tile 切片缓存：WAVEFORM_TILE_WIDTH = 1200px。

## BPM 与网格线
1. 进入自动混音窗口触发 `mixtape:analyze-bpm`，逐曲重新分析 BPM。
2. BPM 结果仅更新 Mixtape 内存数据，不写回数据库或全局缓存。
3. 分析中显示遮罩，网格线暂停绘制。
4. 分析失败：显示失败提示并禁用网格线，避免错误对拍。
5. 网格线绘制基于每首歌 BPM，firstBeat 目前固定 0（未做节拍对齐）。

## 交互与可视
1. 鼠标悬停轨道显示粗边框（不做高亮填充）。
2. 轨道左上角信息块显示序号/标题/BPM，灰色不透明背景，层级高于网格线。
3. 信息块始终保持在窗口内，离开视口会自动右移。
4. 缩略图视口框始终显示。

## 渲染与性能策略
1. 视口外裁剪：渲染范围 = 视口范围 ± 1 个 tile（1200px）。
2. 预渲染队列仅覆盖当前 renderZoom 档位，避免全档位铺满。
3. Worker 缓冲：MIXTAPE_BUFFER_MULTIPLIER = 3。
4. 缩放/滚动合并到下一帧绘制（RAF 合并）。

## 已完成
1. 固定两轨交替布局，首尾相接拼接。
2. 时间线宽度缩小到 1/10。
3. 缩放范围调整为 0.1 ~ 2，渲染量化为 0.2 步进。
4. 真实波形全档位渲染，摘要波形关闭。
5. 视口外动态裁剪渲染，背景纹理已移除。
6. 轨道高度固定为 288px，不随缩放变化。
7. 自动混音窗口 BPM 重新分析，高精度仅本窗口生效。
8. BPM 分析遮罩与失败提示上线，失败时禁用网格线。
9. 轨道悬停边框 + 信息块已实现，信息块自动保持在窗口内。
10. 缩略图视口框常显。

## 待确认/待办
1. 高倍缩放拖动是否满足预期，是否需要继续调缓冲/采样策略。
2. BPM 分析失败的具体原因统计（例如文件不可读/解析失败）是否需要上报。
3. 是否需要加入对齐起拍点（firstBeat）能力（当前固定 0）。

## 验收标准
1. 2x 放大下波形细节清晰可辨。
2. 左右拖动顺滑，无大面积卡顿。
3. 轨道高度固定不随缩放变化。
4. 进入自动混音后 BPM 分析完成即可绘制网格线；分析失败时提示且网格线不绘制。

## 影响文件
1. `src/renderer/src/Mixtape.vue`
2. `src/renderer/src/workers/mixtapeWaveformRender.worker.ts`
3. `src/main/ipc/mixtapeHandlers.ts`
4. `src/renderer/src/i18n/locales/zh-CN.json`
5. `src/renderer/src/i18n/locales/en-US.json`
