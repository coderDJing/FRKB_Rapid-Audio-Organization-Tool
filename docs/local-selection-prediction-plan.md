# 本地精选预测方案（草案）

## 背景与目标
- 需求：基于历史“已加入精选”的曲目（即便文件已删除）预测筛选库里最可能加入精选的候选；全程离线、用户零配置。
- 约束：仅使用歌曲自身信息（音频内容 + 元数据），不引入播放/跳过等行为特征；纯本地推理，不依赖服务器。
- 目标：在桌面端提供高精度的候选排序，优先准确率，其次兼顾包体和延迟。

## 数据与特征前提
- 正样本：历史精选曲目（含已删除文件），需保留元数据快照 + 音频指纹/嵌入。
- 负样本：筛选库中未被加入精选的曲目，可随机采样或取时间邻近但未选中的项。
- 音频特征：首选高保真嵌入（CLMR/OpenL3/VGGish 之一），辅以 Chromaprint、HPCP/Chroma 向量、BPM、调式、响度、时长等统计特征。
- 元数据特征：艺人/流派/专辑/年份、BPM/调式/时长、比特率；标题/标签可做文本相似度（轻量 TF-IDF 或小型文本嵌入）。

## 模型选型（准确率优先）
- 优先：**CLMR 完整版（或高容量蒸馏版，44.1 kHz，原生 512 维，可裁剪到 256）**，音乐域相似度最好。
- 次选：OpenL3 small（128/256 维，16 kHz），平衡效果与性能，易部署。
- 兜底：VGGish（128 维，16 kHz），最轻但音乐细节较弱。
- 若算力/包体允许，可探索更大音频 Transformer（PaSST/Audio-MAE/MERT）的 ONNX 版，但部署复杂度更高。

## 部署形态（开箱即用）
- 推荐链路：开发阶段将模型转 ONNX → Rust 侧用 `onnxruntime` (`ort`) 推理 → 暴露 N-API 给 Electron；随应用打包 ORT 动态库或静态链接，首次运行零下载。
- 兜底：提供 wasm 推理路径（更慢、零原生依赖）以兼容平台差异。
- 预处理：音频解码/重采样、梅尔谱/增广等前处理尽量放在 Rust 侧，减少 JS 往返与 CPU 开销。
- 包体管理：模型与 ORT 二进制可压缩/分片随安装包，启动时校验哈希后解压到 `userData`。

## 推理与排序流程
1) **离线特征提取**  
   - 为筛选库批量提取音频嵌入 + Chromaprint/HPCP/BPM 等统计特征，写入本地缓存（如 SQLite/压缩 JSON/自定义二进制）。  
   - 对历史精选（含已删文件）使用已存快照的嵌入/指纹，无文件则只用已有特征。
2) **召回（相似度优先保证覆盖）**  
   - 用历史精选的嵌入做查询，余弦相似度暴力或 HNSW（hnswlib-rs，索引持久化）。  
   - 召回 Top-N（如 200–500），可用多质心（对精选聚类）避免主流偏好覆盖不足。
3) **重排（提高准确率）**  
   - 轻量 LR/GBDT 只用内容特征：音频相似度、Chromaprint/HPCP 距离、BPM/调式差、元数据匹配度（艺人/流派/年份/时长/比特率）、标题/标签相似度。  
   - 若暂不训练，可用加权规则先行：音频相似度为主，元数据作平滑加分/扣分（如低比特率、异常时长）。  
   - 输出最终排序，前端展示 Top-K 候选。
4) **缓存与更新**  
   - 嵌入/索引持久化，检测文件 mtime/哈希变化后增量更新。  
   - 模型/索引版本号记录，便于升级时重建或迁移。

## 性能与体验
- 预处理/推理线程池在 Rust 侧控制，避免阻塞主进程；长任务要有可取消/进度回报。
- 曲库 < 数万：直接矩阵相似度即可；更大规模用 HNSW。  
- 首次批量提取可分批执行并落盘中间结果，防止崩溃丢进度。
- 低配机型可切换到 OpenL3/VGGish 模式（或 wasm 路径）作为降级。

## 许可证与合规
- CLMR/OpenL3/VGGish 均为 MIT/Apache 兼容，可随包分发；需确认转出的 ONNX/二进制依赖的许可证。  
- 不使用外部服务，无额外隐私风险；音频仅本地处理。

## 待澄清/决策点
- 最终默认模型：是直接上 CLMR（效果最好但重），还是默认 OpenL3，提供“高精度模式”切换 CLMR？  
- 目标包体与可接受的首次索引时间（决定是否预置嵌入或按需懒提取）。  
- 元数据特征的来源与完整性（是否可靠有 BPM/调式/流派），决定重排特征权重设计。

## 下一步建议
1) 确认默认模型与包体/延迟指标，拍板“高精度/兼容”两档策略。  
2) 选定推理栈（Rust + ort），完成模型 ONNX 转换与最小推理原型（单曲推理 + Top-N 召回）。  
3) 设计特征缓存与索引存储格式（含版本与校验），实现增量更新。  
4) 用历史精选/非精选样本快速训练或调试一版加权规则/小型 LR，评估 Precision@K/NDCG。  
5) 前端规划：候选列表展示、进度/取消、模式切换（标准/高精度）与错误提示。
