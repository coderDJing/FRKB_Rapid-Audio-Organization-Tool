# Symphonia vs FFmpeg 音频格式支持对比

## 概述

- **Symphonia**: Rust 编写的纯音频解码库，专注于解码功能，无编码能力
- **FFmpeg**: 功能全面的多媒体处理框架，支持编解码、转码、流处理等
- **当前实现**: 主流程先尝试 Symphonia，遇到不支持/解码失败时自动调用随包 FFmpeg 回退，统一输出 Float32 PCM

## 格式支持对比表

| 格式/编解码器 | 文件扩展名 | Symphonia 0.5.5 | FFmpeg | 当前实现（Symphonia → FFmpeg 回退） |
|-------------|----------|----------------|--------|-------------------------------------|
| **MP3** | `.mp3` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **WAV (PCM)** | `.wav` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **FLAC** | `.flac` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **AIFF/AIF** | `.aiff`, `.aif` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **OGG Vorbis** | `.ogg` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **Opus** | `.opus` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **AAC** | `.aac` | ✅ 支持 | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **MP4/M4A** | `.mp4`, `.m4a` | ✅ 支持（mp4 feature） | ✅ 支持 | ✅ 直接由 Symphonia 解码 |
| **Ogg/Matroska PCM** | `.mka` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **WMA** | `.wma` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **AC3** | `.ac3` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **DTS** | `.dts` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **WebM Audio** | `.webm` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **APE (Monkey's Audio)** | `.ape` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **TAK** | `.tak` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **TTA** | `.tta` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |
| **WavPack** | `.wv` | ❌ 不支持 | ✅ 支持 | ✅ 通过 FFmpeg 回退解码 |

## 功能对比

### Symphonia 0.5.5
- ✅ **纯解码库**：专注于音频解码
- ✅ **Rust 原生**：无外部依赖，纯 Rust 实现
- ✅ **内存安全**：Rust 的内存安全保证
- ✅ **轻量级**：体积小，编译后二进制文件小
- ✅ **跨平台**：支持 Windows、macOS、Linux
- ❌ **无编码功能**：只能解码，不能编码
- ❌ **格式支持有限**：主要支持主流格式
- ❌ **无视频支持**：仅音频处理

### FFmpeg
- ✅ **编解码支持**：同时支持编码和解码
- ✅ **格式广泛**：支持数百种音频/视频格式
- ✅ **功能全面**：转码、流处理、滤镜、元数据处理等
- ✅ **成熟稳定**：经过多年发展，广泛使用
- ✅ **视频支持**：完整的视频处理能力
- ❌ **体积较大**：二进制文件较大
- ❌ **外部依赖**：需要单独安装或打包
- ❌ **C 语言实现**：需要绑定到其他语言

## 当前项目中的应用

### 解码阶段（按扩展名路由 + 兜底回退）
- **路由优先**：已知仅 FFmpeg 覆盖较好的格式（如 WMA、AC3、DTS、APE、TAK、TTA、WV、MKA、WebM 等）直接用 FFmpeg，避免“先试 Symphonia 再回退”的重复探测
- **兜底回退**：对其余主流格式（MP3、WAV、FLAC、AIF、AIFF、OGG、Opus、AAC、M4A/MP4）优先用 Symphonia。若遇到扩展名伪装/文件损坏/容器与编解码器组合异常导致 Symphonia 失败，则自动回退 FFmpeg
- **指纹一致**：无论采用哪条路径，最终都标准化为 16-bit PCM 再计算内容哈希，保证去重/指纹逻辑一致

### 转码阶段（使用 FFmpeg）
- 目标格式动态取“可播放格式 ∩ 本机可用编码器”，通过 `ffmpeg -encoders` 过滤
- 典型可用：MP3(libmp3lame)、FLAC、WAV/AIFF(PCM)、AAC/M4A/MP4、OGG(vorbis)、Opus、WMA、AC3、DTS(如启用 dca)、WavPack(WV)、TTA、WebM(Opus)、MKA(Flac)
- 元数据：默认 `-map_metadata 0`，容器不支持的字段将被忽略

## 建议

### 对于当前项目
1. **解码**：已采用 “Symphonia 优先 + FFmpeg 回退” 混合方案
   - 常规主流格式由 Symphonia 处理，提升性能并避免额外依赖
   - WMA、AC3、DTS、APE、TAK、TTA、WV、MKA、WebM 等由 FFmpeg 自动兜底
2. **转码**：继续由 FFmpeg 负责，保持原有流程与参数配置

### 如果需要支持更多格式
- 可在前端 `allFormats` 中添加新的扩展名，并在 Rust 回退逻辑中直接复用 FFmpeg，无需额外编码
- 如需更广的专业/实验性格式（如 AMR、GSM、Shorten 等），同样可以通过增加扩展名并依赖 FFmpeg 解码实现

## 总结

| 特性 | Symphonia | FFmpeg |
|-----|-----------|--------|
| **支持的音频格式数量** | ~10 种主流格式 | 100+ 种格式 |
| **编码能力** | ❌ 无 | ✅ 有 |
| **解码能力** | ✅ 有 | ✅ 有 |
| **视频支持** | ❌ 无 | ✅ 有 |
| **外部依赖** | ❌ 无 | ✅ 需要 |
| **二进制大小** | 小 | 大 |
| **性能** | 优秀 | 优秀 |
| **适用场景** | 纯音频解码应用 | 多媒体处理应用 |

**当前项目的组合策略**：
- 播放/指纹：Symphonia → FFmpeg 自动回退，可覆盖 19 种常用音频扩展名
- 转码：FFmpeg 负责，沿用既有参数与流程
- 文档与设置已同步更新，默认启用所有可支持格式（可在设置中一键全选/全不选）

